Basta entrar direto no arquivo index para rodar o App

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador de Desempenho Acadêmico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #ffffff;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .modal-backdrop { background-color: rgba(30, 30, 30, 0.7); backdrop-filter: blur(4px); }
        .bg-neutral-900 { background-color: #1a1a1a; }
        .bg-neutral-800 { background-color: #262626; }
        .border-neutral-700 { border-color: #404040; }
        .border-neutral-800 { border-color: #262626; }
        .hover\:bg-neutral-700:hover { background-color: #404040; }
        .ring-offset-black { --tw-ring-offset-color: #000; }
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type='number'] { -moz-appearance: textfield; }
        
        .schedule-grid { display: grid; grid-template-columns: 60px repeat(6, 1fr); gap: 1px; }
        .schedule-cell, .schedule-header { background-color: #1a1a1a; min-height: 50px; display: flex; align-items: center; justify-content: center; font-size: 12px; padding: 4px; }
        .schedule-cell { cursor: pointer; transition: background-color 0.2s; }
        .schedule-cell:not(.schedule-time):hover { background-color: #2a2a2a; }
        .schedule-cell .remove-class, .card-delete-button, .todo-delete-button { display: none; }
        .schedule-cell:hover .remove-class { display: block; }
        .semester-card:hover .card-delete-button, .subject-card:hover .card-delete-button, .todo-item:hover .todo-delete-button { display: flex; }
        .assessment-actions { opacity: 0; transition: opacity 0.2s; }
        tr:hover .assessment-actions { opacity: 1; }
        .todo-item-text.completed { text-decoration: line-through; color: #525252; }
        .tab-button.active { border-color: #3b82f6; color: #ffffff; }
    </style>
</head>
<body class="bg-black text-white">

    <div id="app" class="min-h-screen w-full">
        <div id="profile-selection-screen" class="min-h-screen flex flex-col items-center justify-center p-4 text-center"> <h1 class="text-4xl md:text-5xl font-bold mb-10">Selecione o Usuário</h1> <div id="profiles-list" class="flex flex-wrap justify-center items-start gap-6 md:gap-8 mb-10"></div> <button id="add-profile-button" class="mt-4 px-6 py-3 bg-transparent border-2 border-neutral-700 text-neutral-400 rounded-lg hover:bg-neutral-800 hover:text-white transition-colors">Adicionar Perfil</button> </div>
        
        <div id="create-profile-screen" class="hidden min-h-screen flex items-center justify-center p-4"></div>
        
        <div id="main-dashboard-screen" class="hidden w-full min-h-screen flex-col">
            <header class="bg-black/80 backdrop-blur-sm p-4 border-b border-neutral-800 flex justify-between items-center sticky top-0 z-20">
                <div class="flex items-center gap-6">
                    <h1 id="welcome-message" class="text-xl md:text-2xl font-bold"></h1>
                    <nav id="main-nav" class="flex gap-2">
                        <button data-view="semesters-view" class="nav-button px-4 py-2 rounded-md text-sm font-semibold">Matérias</button>
                        <button data-view="schedule-view" class="nav-button px-4 py-2 rounded-md text-sm font-semibold">Grade Horária</button>
                        <button data-view="todo-view" class="nav-button px-4 py-2 rounded-md text-sm font-semibold text-neutral-400">To-do List</button>
                        <button data-view="profile-view" class="nav-button px-4 py-2 rounded-md text-sm font-semibold text-neutral-400">Perfil</button>
                    </nav>
                </div>
                <div class="flex items-center gap-4">
                    <button id="ai-assistant-button" title="Assistente IA" class="px-3 py-2 bg-blue-800/50 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"> <i data-feather="cpu" class="w-5 h-5"></i><span class="hidden md:inline">Assistente IA</span> </button>
                    <button id="logout-button" class="px-4 py-2 bg-neutral-800 text-white rounded-lg hover:bg-neutral-700 transition-colors flex items-center gap-2"> <i data-feather="log-out" class="w-5 h-5"></i><span class="hidden md:inline">Sair</span> </button>
                </div>
            </header>
            <main id="dashboard-content" class="flex-grow p-4 md:p-8"></main>
        </div>
    </div>
    
    <footer class="text-center text-xs text-neutral-600 py-4">
        Copyright (C) Asabbath Engine 2025. versão 2.6.0.20250722
    </footer>

    <div id="add-semester-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"></div>
    <div id="add-subject-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"></div>
    <div id="manage-assessments-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"></div>
    <div id="add-to-schedule-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"></div>
    <div id="delete-confirmation-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"></div>
    <div id="ai-assistant-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"></div>

    <template id="profile-card-template"> <div class="flex flex-col items-center gap-3 cursor-pointer group"> <img src="https://placehold.co/160x160/1a1a1a/ffffff?text=Perfil" alt="Foto do perfil" class="w-28 h-28 md:w-40 md:h-40 object-cover rounded-full border-4 border-transparent group-hover:border-white transition-all duration-300"> <span class="profile-card-name text-xl font-semibold text-neutral-200 group-hover:text-white"></span> <span class="profile-card-university text-sm font-medium text-neutral-400 group-hover:text-neutral-300"></span> </div> </template>
    <template id="semester-card-template"> <div class="semester-card bg-neutral-900 rounded-lg p-5 flex flex-col justify-between h-40 cursor-pointer relative group border-l-4 border-neutral-700 hover:border-white"> <button class="card-delete-button absolute top-2 right-2 w-8 h-8 rounded-full bg-red-800/50 hover:bg-red-800 items-center justify-center text-red-300 hover:text-white"> <i data-feather="trash-2" class="w-4 h-4"></i> </button> <div class="card-content flex-grow flex flex-col justify-between"> <div><h3 class="semester-card-name font-bold text-xl"></h3></div> <div class="mt-auto"> <p class="text-sm text-neutral-300 font-semibold">IRA: <span class="semester-ira font-bold text-white">0.00</span></p> <p class="text-right text-sm text-neutral-400"> <span class="subject-count">0 matérias</span> </p> </div> </div> </div> </template>
    <template id="subject-card-template"> <div class="subject-card bg-neutral-900 rounded-lg p-5 flex flex-col justify-between h-36 cursor-pointer relative group border-l-4"> <button class="card-delete-button absolute top-2 right-2 w-8 h-8 rounded-full bg-red-800/50 hover:bg-red-800 items-center justify-center text-red-300 hover:text-white"> <i data-feather="trash-2" class="w-4 h-4"></i> </button> <div class="card-content flex-grow flex flex-col justify-between"> <div><h3 class="subject-card-name font-bold text-xl"></h3></div> <div class="text-right text-sm text-neutral-400"> <span class="assessment-count">0 avaliações</span> </div> </div> </div> </template>
    <template id="assessment-row-template"> <tr class="border-b border-neutral-700"> <td class="p-4 assessment-name"></td> <td class="p-4 text-center"><span class="assessment-score"></span> / <span class="assessment-max-score"></span></td> <td class="p-4 text-right font-bold assessment-percentage"></td> <td class="p-4 text-right"> <div class="assessment-actions flex items-center justify-end gap-2"> <button class="delete-assessment-button text-red-500/70 hover:text-red-500"><i data-feather="trash-2" class="w-4 h-4"></i></button> </div> </td> </tr> </template>
    <template id="todo-item-template"> <div class="todo-item flex items-center gap-4 p-4 bg-neutral-900 rounded-lg"> <input type="checkbox" class="todo-checkbox h-5 w-5 rounded bg-neutral-700 border-neutral-600 text-blue-500 focus:ring-blue-600 ring-offset-neutral-900"> <label class="flex-grow todo-item-text cursor-pointer"></label> <button class="todo-delete-button items-center justify-center text-red-500/70 hover:text-red-500"> <i data-feather="trash-2" class="w-5 h-5"></i> </button> </div> </template>

    <script>
        // FIX: Wrap entire script in a try-catch to prevent any single error from halting execution
        try {
            // FIX: Register plugin immediately to ensure it's available for all chart functions.
            if (window.ChartjsPluginAnnotation) {
                Chart.register(window.ChartjsPluginAnnotation);
            } else {
                console.error("Chart.js Annotation plugin could not be found. Annotations will be disabled.");
            }

            document.addEventListener('DOMContentLoaded', () => {
                // =================================================================================
                // --- ESTADO E CONFIGURAÇÃO INICIAL ---
                // =================================================================================
                let appData = { profiles: [], selectedProfileId: null, currentSemesterId: null, currentSubjectId: null, currentTimeslotId: null, itemToDelete: null };
                let subjectChartInstance, generalChartInstance = null;
                const subjectColors = {
                    blue: { border: 'border-blue-500', bg: 'bg-blue-900', rgb: 'rgba(59, 130, 246, 0.5)' },
                    red: { border: 'border-red-500', bg: 'bg-red-900', rgb: 'rgba(239, 68, 68, 0.5)' },
                    green: { border: 'border-green-500', bg: 'bg-green-900', rgb: 'rgba(34, 197, 94, 0.5)' },
                    yellow: { border: 'border-yellow-400', bg: 'bg-yellow-800', rgb: 'rgba(250, 204, 21, 0.5)' },
                    purple: { border: 'border-purple-500', bg: 'bg-purple-900', rgb: 'rgba(168, 85, 247, 0.5)' },
                    pink: { border: 'border-pink-500', bg: 'bg-pink-900', rgb: 'rgba(236, 72, 153, 0.5)' },
                };
                const screens = { profileSelection: document.getElementById('profile-selection-screen'), createProfile: document.getElementById('create-profile-screen'), mainDashboard: document.getElementById('main-dashboard-screen') };
                const modals = { addSemester: document.getElementById('add-semester-modal'), addSubject: document.getElementById('add-subject-modal'), manageAssessments: document.getElementById('manage-assessments-modal'), addToSchedule: document.getElementById('add-to-schedule-modal'), deleteConfirmation: document.getElementById('delete-confirmation-modal'), aiAssistant: document.getElementById('ai-assistant-modal') };
                
                // =================================================================================
                // --- FUNÇÕES DE DADOS (CARREGAR E SALVAR) ---
                // =================================================================================
                function saveData() { localStorage.setItem('studentTrackerApp', JSON.stringify(appData)); }
                function loadData() {
                    const savedData = localStorage.getItem('studentTrackerApp');
                    if (!savedData) return;
                    appData = JSON.parse(savedData);
                    // Data migration for new features
                    appData.profiles.forEach(profile => {
                        if (profile.subjects && !profile.semesters) {
                            profile.semesters = [{ id: Date.now(), name: "Período Padrão", subjects: profile.subjects }];
                            delete profile.subjects;
                        }
                        if (!profile.schedule) profile.schedule = {};
                        if (!profile.semesters) profile.semesters = [];
                        if (!profile.todos) profile.todos = [];
                        delete profile.notes; 
                        profile.semesters.forEach(semester => {
                            semester.subjects.forEach(subject => {
                                if (subject.acronym === undefined) subject.acronym = '';
                                if (subject.professor === undefined) subject.professor = '';
                                if (subject.classroom === undefined) subject.classroom = '';
                                if (subject.credits === undefined) subject.credits = 0;
                                if (subject.passingGrade === undefined) subject.passingGrade = 60;
                                if (subject.assessmentDefinitions === undefined) {
                                    subject.assessmentDefinitions = [];
                                    subject.assessments.forEach(asm => {
                                        if (asm.definitionId === undefined) {
                                            const defId = Date.now() + Math.random();
                                            const oldName = asm.name || "Avaliação";
                                            const oldMaxScore = asm.maxScore || 100;
                                            subject.assessmentDefinitions.push({ id: defId, name: oldName, maxScore: oldMaxScore });
                                            asm.definitionId = defId;
                                            delete asm.name;
                                            delete asm.maxScore;
                                        }
                                    });
                                }
                                subject.assessments.forEach(asm => {
                                    if (asm.id === undefined) asm.id = Date.now() + Math.random();
                                    delete asm.date; // Remove date property
                                });
                            });
                        });
                    });
                }
                function getCurrentProfile() { return appData.profiles.find(p => p.id === appData.selectedProfileId); }
                function getCurrentSemester() { const profile = getCurrentProfile(); if (!profile || !appData.currentSemesterId) return null; return profile.semesters.find(s => s.id === appData.currentSemesterId); }
                function getCurrentSubject() { const semester = getCurrentSemester(); if (!semester || !appData.currentSubjectId) return null; return semester.subjects.find(s => s.id === appData.currentSubjectId); }

                // =================================================================================
                // --- FUNÇÕES DE CÁLCULO (MÉDIAS E IRA) ---
                // =================================================================================
                function calculateWeightedAverage(assessments, definitions) {
                    if (!assessments || assessments.length === 0) return 0;

                    const totalWeightedPercentage = assessments.reduce((sum, asm) => {
                        const definition = definitions.find(d => d.id === asm.definitionId);
                        if (!definition) return sum;
                        const percentage = (asm.score / definition.maxScore) * 100;
                        return sum + (percentage * definition.maxScore);
                    }, 0);

                    const totalWeightOfGraded = assessments.reduce((sum, asm) => {
                        const definition = definitions.find(d => d.id === asm.definitionId);
                        return sum + (definition?.maxScore || 0);
                    }, 0);

                    if (totalWeightOfGraded === 0) return 0;
                    
                    return totalWeightedPercentage / totalWeightOfGraded;
                }

                function calculateIra(subjects) {
                    let totalCredits = 0;
                    let weightedSum = 0;
                    subjects.forEach(subject => {
                        const credits = subject.credits || 0;
                        if (credits > 0 && subject.assessments.length > 0) {
                            const average = calculateWeightedAverage(subject.assessments, subject.assessmentDefinitions);
                            weightedSum += (average * credits);
                            totalCredits += credits;
                        }
                    });
                    if (totalCredits === 0) return "0.00";
                    const ira = weightedSum / totalCredits;
                    return (ira / 10).toFixed(2); // Assuming IRA is on a 0-10 scale
                }

                // =================================================================================
                // --- FUNÇÕES DE UI E NAVEGAÇÃO ---
                // =================================================================================
                function showScreen(screenName) { Object.values(screens).forEach(s => s.classList.add('hidden')); if(screens[screenName]) screens[screenName].classList.remove('hidden'); }
                function showModal(modalName) { if(modals[modalName]) modals[modalName].classList.remove('hidden'); }
                function hideModals() { Object.values(modals).forEach(m => m.classList.add('hidden')); }
                function switchView(viewName) {
                    const contentArea = document.getElementById('dashboard-content');
                    contentArea.innerHTML = '';
                    document.querySelectorAll('.nav-button').forEach(btn => {
                        btn.classList.toggle('bg-neutral-800', btn.dataset.view === viewName);
                        btn.classList.toggle('text-white', btn.dataset.view === viewName);
                        btn.classList.toggle('text-neutral-400', btn.dataset.view !== viewName);
                    });
                    if (viewName === 'semesters-view') renderSemestersList();
                    else if (viewName === 'schedule-view') renderScheduleGrid();
                    else if (viewName === 'profile-view') renderProfileView();
                    else if (viewName === 'todo-view') renderTodoView();
                }

                // =================================================================================
                // --- FUNÇÕES DE RENDERIZAÇÃO DE COMPONENTES ---
                // =================================================================================
                function renderProfiles() { const list = document.getElementById('profiles-list'); list.innerHTML = ''; document.getElementById('add-profile-button').textContent = appData.profiles.length === 0 ? 'Criar Novo Perfil' : 'Adicionar Outro Perfil'; appData.profiles.forEach(profile => { const card = document.getElementById('profile-card-template').content.cloneNode(true); const div = card.querySelector('.group'); div.querySelector('img').src = profile.photoUrl || `https://placehold.co/160x160/1a1a1a/ffffff?text=${profile.name.charAt(0)}`; div.querySelector('.profile-card-name').textContent = profile.name; div.querySelector('.profile-card-university').textContent = profile.university; div.addEventListener('click', () => selectProfile(profile.id)); list.appendChild(card); }); }
                function renderDashboard() { const profile = getCurrentProfile(); if (!profile) return; document.getElementById('welcome-message').textContent = `${profile.name}`; switchView('semesters-view'); }
                function renderSemestersList() {
                    const profile = getCurrentProfile();
                    const allSubjects = profile.semesters.flatMap(s => s.subjects);
                    const overallIra = calculateIra(allSubjects);
                    const contentArea = document.getElementById('dashboard-content');
                    contentArea.innerHTML = `<div class="mb-8"><div class="bg-neutral-900 rounded-lg p-6"><h3 class="text-lg font-semibold text-neutral-400">IRA Geral</h3><p class="text-5xl font-bold text-white">${overallIra}</p></div></div><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold">Semestres</h2><button id="open-add-semester-modal-button" class="px-5 py-2.5 bg-white text-black rounded-lg hover:bg-neutral-200 transition-colors flex items-center gap-2 font-semibold"><i data-feather="plus-circle" class="w-5 h-5"></i><span>Novo Semestre</span></button></div><div id="semesters-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>`;
                    const grid = document.getElementById('semesters-grid');
                    profile.semesters.forEach(semester => {
                        const card = document.getElementById('semester-card-template').content.cloneNode(true);
                        const cardDiv = card.querySelector('.semester-card');
                        cardDiv.querySelector('.card-content').addEventListener('click', () => renderSingleSemesterView(semester.id));
                        cardDiv.querySelector('.semester-card-name').textContent = semester.name;
                        cardDiv.querySelector('.subject-count').textContent = `${semester.subjects.length} matérias`;
                        cardDiv.querySelector('.semester-ira').textContent = calculateIra(semester.subjects);
                        cardDiv.querySelector('.card-delete-button').addEventListener('click', (e) => { e.stopPropagation(); openDeleteConfirmationModal('semester', semester.id, semester.name); });
                        grid.appendChild(card);
                    });
                    document.getElementById('open-add-semester-modal-button').addEventListener('click', () => showModal('addSemester'));
                    feather.replace();
                }
                function renderSingleSemesterView(semesterId) {
                    appData.currentSemesterId = parseInt(semesterId);
                    const semester = getCurrentSemester();
                    const profile = getCurrentProfile();
                    const contentArea = document.getElementById('dashboard-content');
                    contentArea.innerHTML = `<div class="flex justify-between items-center mb-6"><button id="back-to-semesters" class="text-neutral-400 hover:text-white flex items-center gap-2"><i data-feather="arrow-left"></i> <span>Todos os Semestres</span></button><button id="open-add-subject-modal-button" class="px-5 py-2.5 bg-white text-black rounded-lg hover:bg-neutral-200 transition-colors flex items-center gap-2 font-semibold"><i data-feather="plus-circle" class="w-5 h-5"></i><span>Nova Matéria</span></button></div><h2 class="text-3xl font-bold mb-6">${profile.university} ${semester.name}</h2><div id="general-chart-container" class="mb-8"><div class="bg-neutral-900 p-4 rounded-lg"><canvas id="general-chart"></canvas></div></div><div id="subjects-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>`;
                    renderSubjects(semester);
                    renderGeneralChart(semester);
                    document.getElementById('back-to-semesters').addEventListener('click', renderSemestersList);
                    document.getElementById('open-add-subject-modal-button').addEventListener('click', () => showModal('addSubject'));
                    feather.replace();
                }
                function renderSubjects(semester) {
                    const grid = document.getElementById('subjects-grid');
                    grid.innerHTML = '';
                    semester.subjects.forEach(subject => {
                        const card = document.getElementById('subject-card-template').content.cloneNode(true);
                        const cardDiv = card.querySelector('.subject-card');
                        cardDiv.classList.add(subjectColors[subject.color]?.border || 'border-neutral-700');
                        cardDiv.querySelector('.card-content').addEventListener('click', () => showSubjectDetails(subject.id));
                        cardDiv.querySelector('.subject-card-name').textContent = subject.name;
                        cardDiv.querySelector('.assessment-count').textContent = `${subject.assessments.length} / ${subject.assessmentDefinitions.length} avaliações`;
                        cardDiv.querySelector('.card-delete-button').addEventListener('click', (e) => { e.stopPropagation(); openDeleteConfirmationModal('subject', subject.id, subject.name); });
                        grid.appendChild(card);
                    });
                    feather.replace();
                }
                function showSubjectDetails(subjectId) {
                    appData.currentSubjectId = parseInt(subjectId);
                    const subject = getCurrentSubject();
                    const semester = getCurrentSemester();
                    const contentArea = document.getElementById('dashboard-content');
                    contentArea.innerHTML = `<div class="flex justify-between items-center mb-6"><button id="back-to-subjects" class="text-neutral-400 hover:text-white flex items-center gap-2"><i data-feather="arrow-left"></i> <span>Voltar para ${semester.name}</span></button><button id="open-manage-assessments-modal-button" class="px-5 py-2.5 bg-white text-black rounded-lg hover:bg-neutral-200 transition-colors flex items-center gap-2 font-semibold"><i data-feather="settings" class="w-5 h-5"></i><span>Gerenciar Avaliações</span></button></div><div class="mb-6"><h2 class="text-3xl font-bold">${subject.name} (${subject.acronym || 'N/A'})</h2><p class="text-neutral-400 mt-1">Professor(a): ${subject.professor || 'Não informado'} | Sala: ${subject.classroom || 'Não informada'} | Créditos: ${subject.credits || 0}</p></div><div class="my-6"><div class="bg-neutral-900 p-4 rounded-lg"><canvas id="subject-chart"></canvas></div></div><h3 class="text-2xl font-bold mb-4">Notas Lançadas</h3><div id="assessments-list" class="bg-neutral-900 rounded-lg overflow-hidden"></div>`;
                    renderAssessments(subject);
                    renderSubjectChart(subject);
                    document.getElementById('back-to-subjects').addEventListener('click', () => renderSingleSemesterView(semester.id));
                    document.getElementById('open-manage-assessments-modal-button').addEventListener('click', () => renderManageAssessmentsModal(subject));
                    feather.replace();
                }
                function renderAssessments(subject) {
                    const list = document.getElementById('assessments-list');
                    list.innerHTML = `<table class="w-full text-left"><thead class="bg-neutral-800"><tr><th class="p-4 font-semibold">Avaliação</th><th class="p-4 font-semibold text-center">Nota</th><th class="p-4 font-semibold text-right">Aproveitamento</th><th class="p-4 w-24"></th></tr></thead><tbody id="assessment-table-body"></tbody></table>`;
                    const tbody = document.getElementById('assessment-table-body');
                    if (subject.assessments.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-neutral-400">Nenhuma nota lançada. Gerencie as avaliações para começar.</td></tr>';
                        return;
                    }
                    subject.assessments.forEach(asm => {
                        const definition = subject.assessmentDefinitions.find(d => d.id === asm.definitionId);
                        if (!definition) return;
                        const row = document.getElementById('assessment-row-template').content.cloneNode(true);
                        const percentage = (asm.score / definition.maxScore * 100);
                        row.querySelector('.assessment-name').textContent = definition.name;
                        row.querySelector('.assessment-score').textContent = asm.score;
                        row.querySelector('.assessment-max-score').textContent = definition.maxScore;
                        row.querySelector('.assessment-percentage').textContent = `${percentage.toFixed(1)}%`;
                        row.querySelector('.delete-assessment-button').addEventListener('click', () => openDeleteConfirmationModal('assessment', asm.id, definition.name, subject));
                        tbody.appendChild(row);
                    });
                    feather.replace();
                }
                function renderScheduleGrid() {
                    const contentArea = document.getElementById('dashboard-content');
                    contentArea.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold">Grade Horária</h2></div><div id="schedule-grid-container" class="bg-black p-1 overflow-x-auto"></div>`;
                    const container = document.getElementById('schedule-grid-container');
                    const profile = getCurrentProfile();
                    const days = { mon: 'Seg', tue: 'Ter', wed: 'Qua', thu: 'Qui', fri: 'Sex', sat: 'Sáb' };
                    let gridHTML = '<div class="schedule-grid bg-neutral-800">';
                    gridHTML += '<div class="schedule-header"></div>';
                    Object.values(days).forEach(dayName => { gridHTML += `<div class="schedule-header font-semibold">${dayName}</div>`; });
                    for (let hour = 6; hour <= 22; hour++) {
                        gridHTML += `<div class="schedule-header schedule-time font-semibold">${String(hour).padStart(2, '0')}:00</div>`;
                        Object.keys(days).forEach(dayKey => {
                            const timeslotId = `${dayKey}-${String(hour).padStart(2, '0')}`;
                            const subjectId = profile.schedule[timeslotId];
                            if (subjectId) {
                                const subject = profile.semesters.flatMap(sem => sem.subjects).find(s => s.id === subjectId);
                                if (subject) {
                                    const colorClass = subjectColors[subject.color]?.bg || 'bg-neutral-700';
                                    gridHTML += `<div data-timeslot="${timeslotId}" title="${subject.name} - Sala: ${subject.classroom || 'N/A'}" class="schedule-cell ${colorClass} text-white font-bold p-1 relative group text-center break-words">${subject.acronym || subject.name}<button class="remove-class absolute top-1 right-1 text-white/50 hover:text-white" data-timeslot="${timeslotId}"><i data-feather="x-circle" class="w-4 h-4"></i></button></div>`;
                                } else { gridHTML += `<div data-timeslot="${timeslotId}" class="schedule-cell empty-cell"></div>`; }
                            } else { gridHTML += `<div data-timeslot="${timeslotId}" class="schedule-cell empty-cell"></div>`; }
                        });
                    }
                    gridHTML += '</div>';
                    container.innerHTML = gridHTML;
                    feather.replace();
                    document.querySelectorAll('.empty-cell').forEach(cell => cell.addEventListener('click', () => handleOpenScheduleModal(cell.dataset.timeslot)));
                    document.querySelectorAll('.remove-class').forEach(button => button.addEventListener('click', (e) => { e.stopPropagation(); handleRemoveFromSchedule(button.dataset.timeslot); }));
                }
                function renderProfileView() {
                    const profile = getCurrentProfile();
                    const contentArea = document.getElementById('dashboard-content');
                    contentArea.innerHTML = `<div class="max-w-2xl mx-auto"><h2 class="text-3xl font-bold mb-6">Editar Perfil</h2><div class="bg-neutral-900 p-8 rounded-2xl shadow-lg"><form id="edit-profile-form" class="flex flex-col gap-4"><div><label for="profile-name-edit" class="block text-sm font-medium text-neutral-400 mb-2">Nome</label><input type="text" id="profile-name-edit" value="${profile.name}" class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded-lg" required></div><div><label for="profile-university-edit" class="block text-sm font-medium text-neutral-400 mb-2">Sigla da Faculdade</label><input type="text" id="profile-university-edit" value="${profile.university}" class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded-lg" required></div><div><label for="profile-photo-edit" class="block text-sm font-medium text-neutral-400 mb-2">URL da Foto (opcional)</label><input type="url" id="profile-photo-edit" value="${profile.photoUrl || ''}" placeholder="URL da imagem..." class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded-lg"></div><div class="flex items-center justify-end mt-6 gap-4"><button type="submit" class="px-6 py-3 bg-white text-black rounded-lg font-semibold hover:bg-neutral-200 transition-colors">Salvar Alterações</button></div></form></div><div class="mt-10 border-t border-red-800/30 pt-6"><h3 class="text-xl font-bold text-red-400">Zona de Perigo</h3><p class="text-neutral-400 my-2 text-sm">A exclusão da sua conta é uma ação irreversível. Todos os seus dados, incluindo semestres, matérias e notas, serão perdidos para sempre.</p><button id="open-delete-profile-modal-button" class="mt-2 px-5 py-2.5 bg-red-800 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2 font-semibold"><i data-feather="trash-2" class="w-5 h-5"></i><span>Excluir Minha Conta</span></button></div></div>`;
                    feather.replace();
                    document.getElementById('edit-profile-form').addEventListener('submit', handleUpdateProfile);
                    document.getElementById('open-delete-profile-modal-button').addEventListener('click', () => openDeleteConfirmationModal('profile', profile.id, profile.name));
                }
                function renderTodoView() {
                    const profile = getCurrentProfile();
                    const contentArea = document.getElementById('dashboard-content');
                    contentArea.innerHTML = `<div class="max-w-3xl mx-auto"><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold">Lista de Tarefas</h2></div><form id="add-todo-form" class="flex gap-2 mb-6"><input type="text" id="add-todo-input" placeholder="Adicionar nova tarefa..." class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded-lg" required><button type="submit" class="px-5 py-2.5 bg-white text-black rounded-lg hover:bg-neutral-200 transition-colors flex items-center gap-2 font-semibold"><i data-feather="plus" class="w-5 h-5"></i><span>Adicionar</span></button></form><div id="todo-list" class="flex flex-col gap-3"></div></div>`;
                    const listContainer = document.getElementById('todo-list');
                    const sortedTodos = [...profile.todos].sort((a,b) => a.completed - b.completed);
                    if (sortedTodos.length === 0) { listContainer.innerHTML = '<p class="text-neutral-500 text-center mt-8">Nenhuma tarefa por aqui. Adicione uma acima para começar!</p>'; } 
                    else { sortedTodos.forEach(todo => { const item = document.getElementById('todo-item-template').content.cloneNode(true); const label = item.querySelector('.todo-item-text'); const checkbox = item.querySelector('.todo-checkbox'); label.textContent = todo.text; checkbox.checked = todo.completed; if(todo.completed) { label.classList.add('completed'); } label.addEventListener('click', () => handleToggleTodo(todo.id)); checkbox.addEventListener('change', () => handleToggleTodo(todo.id)); item.querySelector('.todo-delete-button').addEventListener('click', () => handleDeleteTodo(todo.id)); listContainer.appendChild(item); }); }
                    document.getElementById('add-todo-form').addEventListener('submit', handleAddTodo);
                    feather.replace();
                }
                const chartBaseOptions = { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            max: 100, 
                            grid: { color: '#262626' },
                            ticks: {
                                stepSize: 50
                            }
                        }, 
                        x: { 
                            grid: { color: '#262626' } 
                        } 
                    } 
                };
                function renderSubjectChart(subject) {
                    const ctx = document.getElementById('subject-chart').getContext('2d');
                    if (subjectChartInstance) subjectChartInstance.destroy();

                    const sortedAssessments = [...subject.assessments].sort((a, b) => {
                        const defA = subject.assessmentDefinitions.findIndex(d => d.id === a.definitionId);
                        const defB = subject.assessmentDefinitions.findIndex(d => d.id === b.definitionId);
                        return defA - defB;
                    });

                    const labels = sortedAssessments.map(asm => subject.assessmentDefinitions.find(d => d.id === asm.definitionId)?.name || '?');
                    const data = sortedAssessments.map(asm => {
                        const def = subject.assessmentDefinitions.find(d => d.id === asm.definitionId);
                        return def ? (asm.score / def.maxScore * 100) : 0;
                    });
                    
                    const passingGrade = subject.passingGrade || 60;
                    
                    const runningAverageData = [];
                    for (let i = 0; i < sortedAssessments.length; i++) {
                        const currentSlice = sortedAssessments.slice(0, i + 1);
                        runningAverageData.push(calculateWeightedAverage(currentSlice, subject.assessmentDefinitions));
                    }

                    const datasets = [
                        {
                            label: 'Desempenho Individual (%)',
                            data: data,
                            borderColor: subjectColors[subject.color]?.rgb.replace(', 0.5)', ', 1)') || 'rgb(255,255,255)',
                            backgroundColor: subjectColors[subject.color]?.rgb || 'rgba(255, 255, 255, 0.2)',
                            fill: true,
                            tension: 0.4 // Ondulado
                        }
                    ];

                    if (subject.assessments.length > 0) {
                        datasets.push({
                            label: `Média Atual`,
                            data: runningAverageData,
                            borderColor: 'rgba(34, 197, 94, 0.9)',
                            borderWidth: 3,
                            pointBackgroundColor: 'rgba(34, 197, 94, 1)',
                            pointRadius: 4,
                            fill: false,
                            tension: 0 // Linear
                        });
                    }

                    const annotations = {
                        passingLine: {
                            type: 'line',
                            yMin: passingGrade,
                            yMax: passingGrade,
                            borderColor: 'rgba(239, 68, 68, 0.7)',
                            borderWidth: 2,
                            borderDash: [6, 6], // Pontilhado
                            label: {
                                content: `Média p/ Aprovação: ${passingGrade}%`,
                                enabled: true,
                                position: 'start',
                                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                font: { weight: 'bold', size: 10 },
                                padding: 4,
                                borderRadius: 4,
                                yAdjust: -10
                            }
                        }
                    };

                    subjectChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            ...chartBaseOptions,
                            plugins: {
                                legend: { display: true, position: 'bottom', labels: { color: '#a3a3a3' } },
                                annotation: { annotations }
                            }
                        }
                    });
                }
                function renderGeneralChart(semester) {
                    const container = document.getElementById('general-chart-container');
                    if (!container) return;
                    const ctx = document.getElementById('general-chart').getContext('2d');
                    if (generalChartInstance) generalChartInstance.destroy();

                    let maxAssessments = 0;
                    semester.subjects.forEach(s => {
                        if (s.assessmentDefinitions.length > maxAssessments) {
                            maxAssessments = s.assessmentDefinitions.length;
                        }
                    });
                    
                    if (maxAssessments === 0) {
                        container.innerHTML = '<p class="text-center text-neutral-500 p-8">Adicione avaliações nas matérias para ver o gráfico comparativo.</p>';
                        return;
                    }

                    const labels = Array.from({ length: maxAssessments }, (_, i) => `Avaliação ${i + 1}`);
                    const datasets = semester.subjects.map(subject => {
                        const data = [];
                        for (let i = 0; i < maxAssessments; i++) {
                            const definition = subject.assessmentDefinitions[i];
                            if (definition) {
                                const assessment = subject.assessments.find(a => a.definitionId === definition.id);
                                data.push(assessment ? (assessment.score / definition.maxScore * 100) : null);
                            } else {
                                data.push(null);
                            }
                        }
                        return {
                            label: subject.name,
                            data: data,
                            borderColor: subjectColors[subject.color]?.rgb.replace(', 0.5)', ', 1)') || 'rgb(255,255,255)',
                            fill: false,
                            tension: 0.4 // Ondulado
                        };
                    });

                    generalChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            ...chartBaseOptions,
                            plugins: {
                                legend: {
                                    labels: { color: '#ffffff' }
                                }
                            }
                        }
                    });
                }

                // =================================================================================
                // --- MANIPULADORES DE EVENTOS (HANDLERS) ---
                // =================================================================================
                function handleCreateProfile(e) { e.preventDefault(); const name = document.getElementById('profile-name').value.trim(); const university = document.getElementById('profile-university').value.trim(); const photoUrl = document.getElementById('profile-photo').value.trim(); if (!name || !university) return; appData.profiles.push({ id: Date.now(), name, university, photoUrl, semesters: [], schedule: {}, todos: [] }); saveData(); renderProfiles(); e.target.reset(); showScreen('profileSelection'); }
                function handleUpdateProfile(e) { e.preventDefault(); const profile = getCurrentProfile(); if (!profile) return; const newName = document.getElementById('profile-name-edit').value.trim(); const newUniversity = document.getElementById('profile-university-edit').value.trim(); const newPhotoUrl = document.getElementById('profile-photo-edit').value.trim(); if (!newName || !newUniversity) { alert('O nome e a sigla da faculdade são obrigatórios.'); return; } profile.name = newName; profile.university = newUniversity; profile.photoUrl = newPhotoUrl; saveData(); document.getElementById('welcome-message').textContent = `${profile.name}`; renderProfiles(); alert('Perfil atualizado com sucesso!'); }
                function handleAddSemester(e) { e.preventDefault(); const name = document.getElementById('semester-name').value.trim(); if (!name) return; const profile = getCurrentProfile(); profile.semesters.push({ id: Date.now(), name, subjects: [] }); saveData(); renderSemestersList(); e.target.reset(); hideModals(); }
                function handleAddSubject(e) { e.preventDefault(); const name = document.getElementById('subject-name').value.trim(); const acronym = document.getElementById('subject-acronym').value.trim(); const professor = document.getElementById('subject-professor').value.trim(); const classroom = document.getElementById('subject-classroom').value.trim(); const credits = parseInt(document.getElementById('subject-credits').value) || 0; const selectedColor = document.querySelector('input[name="color-choice"]:checked'); if (!name || !selectedColor) { alert('Por favor, preencha pelo menos o nome e escolha uma cor.'); return; } const semester = getCurrentSemester(); semester.subjects.push({ id: Date.now(), name, acronym, professor, classroom, credits, color: selectedColor.value, assessments: [], assessmentDefinitions: [], passingGrade: 60 }); saveData(); renderSingleSemesterView(semester.id); e.target.reset(); hideModals(); }
                function handleAddTodo(e) { e.preventDefault(); const input = document.getElementById('add-todo-input'); const text = input.value.trim(); if (text) { const profile = getCurrentProfile(); profile.todos.unshift({ id: Date.now(), text, completed: false }); saveData(); renderTodoView(); input.value = ''; } }
                function handleToggleTodo(todoId) { const profile = getCurrentProfile(); const todo = profile.todos.find(t => t.id === todoId); if (todo) { todo.completed = !todo.completed; saveData(); renderTodoView(); } }
                function handleDeleteTodo(todoId) { const profile = getCurrentProfile(); profile.todos = profile.todos.filter(t => t.id !== todoId); saveData(); renderTodoView(); }
                function selectProfile(profileId) { appData.selectedProfileId = parseInt(profileId); saveData(); renderDashboard(); showScreen('mainDashboard'); }
                function logout() { appData.selectedProfileId = null; saveData(); showScreen('profileSelection'); }
                function openDeleteConfirmationModal(type, id, name, context) { appData.itemToDelete = { type, id, name, context }; const message = document.getElementById('delete-confirmation-message'); if (type === 'semester') { message.textContent = `Tem certeza que deseja excluir o semestre "${name}"? Todas as matérias e notas contidas nele serão perdidas para sempre.`; } else if (type === 'subject') { message.textContent = `Tem certeza que deseja excluir a matéria "${name}"? Todas as suas avaliações serão perdidas.`; } else if (type === 'profile') { message.textContent = `Tem certeza que deseja excluir o perfil de "${name}"? Todos os seus dados serão perdidos para sempre. Essa ação não pode ser desfeita.`; } else { message.textContent = `Tem certeza que deseja excluir a nota da avaliação "${name}"?`; } showModal('deleteConfirmation'); }
                function handleDeleteItem() { if (!appData.itemToDelete) return; const { type, id, context } = appData.itemToDelete; const profile = getCurrentProfile(); if (type === 'semester') { profile.semesters = profile.semesters.filter(s => s.id !== id); renderSemestersList(); } else if (type === 'subject') { const semester = getCurrentSemester(); if (semester) { semester.subjects = semester.subjects.filter(s => s.id !== id); Object.keys(profile.schedule).forEach(timeslot => { if (profile.schedule[timeslot] === id) { delete profile.schedule[timeslot]; } }); renderSingleSemesterView(semester.id); } } else if (type === 'assessment') { const subject = context; if (subject) { subject.assessments = subject.assessments.filter(a => a.id !== id); showSubjectDetails(subject.id); } } else if (type === 'profile') { appData.profiles = appData.profiles.filter(p => p.id !== id); logout(); } saveData(); hideModals(); appData.itemToDelete = null; }
                function handleOpenScheduleModal(timeslotId) { appData.currentTimeslotId = timeslotId; const [day, hour] = timeslotId.split('-'); const dayNames = { mon: 'Segunda', tue: 'Terça', wed: 'Quarta', thu: 'Quinta', fri: 'Sexta', sat: 'Sábado' }; document.getElementById('schedule-modal-timeslot').textContent = `${dayNames[day]} às ${hour}:00`; const list = document.getElementById('schedule-subject-list'); const profile = getCurrentProfile(); const allSubjects = profile.semesters.flatMap(sem => sem.subjects); list.innerHTML = ''; if (allSubjects.length === 0) { list.innerHTML = '<p class="text-neutral-400">Crie uma matéria primeiro.</p>'; } else { allSubjects.forEach(subject => { const colorClass = subjectColors[subject.color]?.bg || 'bg-neutral-700'; list.innerHTML += `<button data-subject-id="${subject.id}" class="schedule-add-button w-full text-left p-3 rounded-md ${colorClass} hover:opacity-80 transition-opacity">${subject.name}</button>`; }); } document.querySelectorAll('.schedule-add-button').forEach(btn => btn.addEventListener('click', (e) => handleAddToSchedule(e.currentTarget.dataset.subjectId))); showModal('addToSchedule'); }
                function handleAddToSchedule(subjectId) { const profile = getCurrentProfile(); profile.schedule[appData.currentTimeslotId] = parseInt(subjectId); saveData(); renderScheduleGrid(); hideModals(); }
                function handleRemoveFromSchedule(timeslotId) { const profile = getCurrentProfile(); delete profile.schedule[timeslotId]; saveData(); renderScheduleGrid(); }
                
                // =================================================================================
                // --- LÓGICA DO GERENCIADOR DE AVALIAÇÕES ---
                // =================================================================================
                function renderManageAssessmentsModal(subject, activeTab = 'settings') {
                    const modal = modals.manageAssessments;
                    modal.innerHTML = `
                        <div class="bg-neutral-900 p-0 rounded-2xl shadow-lg w-full max-w-2xl border border-neutral-700 flex flex-col">
                            <div class="p-6 border-b border-neutral-800">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-2xl font-bold text-white flex items-center gap-3"><i data-feather="settings" class="text-neutral-400"></i>Gerenciar: ${subject.name}</h3>
                                    <button type="button" class="modal-cancel-button text-neutral-400 hover:text-white">&times;</button>
                                </div>
                                <div class="border-b border-neutral-700 mt-6">
                                    <nav class="-mb-px flex gap-6" aria-label="Tabs">
                                        <button data-tab="settings" class="tab-button shrink-0 border-b-2 py-4 px-1 text-base font-medium text-neutral-400 border-transparent hover:border-neutral-500 hover:text-neutral-300">Configurações</button>
                                        <button data-tab="grades" class="tab-button shrink-0 border-b-2 py-4 px-1 text-base font-medium text-neutral-400 border-transparent hover:border-neutral-500 hover:text-neutral-300">Lançar/Editar Notas</button>
                                    </nav>
                                </div>
                            </div>

                            <div class="p-6 flex-grow overflow-y-auto" style="max-height: 60vh;">
                                <div id="settings-tab-content" class="hidden">
                                    <div class="mb-6">
                                        <label for="passing-grade-input" class="block text-sm font-medium text-neutral-300 mb-2">Média para Aprovação (%)</label>
                                        <input type="number" id="passing-grade-input" value="${subject.passingGrade}" class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded-lg" required>
                                    </div>
                                    <div class="mb-6">
                                        <h4 class="text-lg font-semibold text-neutral-300 mb-3">Estrutura de Avaliação</h4>
                                        <ul id="definitions-list" class="flex flex-col gap-2 mb-4"></ul>
                                        <form id="add-definition-form" class="p-4 bg-neutral-800/50 rounded-lg flex items-end gap-3">
                                            <div class="flex-grow"><label for="def-name" class="text-xs text-neutral-400">Nome da Avaliação</label><input type="text" id="def-name" placeholder="ex: Prova 1" class="w-full p-2 bg-neutral-700 border-neutral-600 rounded-md" required></div>
                                            <div class="w-28"><label for="def-max-score" class="text-xs text-neutral-400">Peso (Nota Máx.)</label><input type="number" id="def-max-score" placeholder="ex: 100" class="w-full p-2 bg-neutral-700 border-neutral-600 rounded-md" required></div>
                                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-500 font-semibold self-end">Adicionar</button>
                                        </form>
                                    </div>
                                </div>
                                <div id="grades-tab-content" class="hidden">
                                    <ul id="grades-list" class="flex flex-col gap-3"></ul>
                                </div>
                            </div>

                            <div class="flex items-center justify-end mt-auto gap-4 border-t border-neutral-800 p-6 bg-neutral-900/50 rounded-b-2xl">
                                <button type="button" class="modal-cancel-button px-6 py-2 bg-neutral-700 rounded-lg">Fechar</button>
                                <button type="button" id="save-all-button" class="px-6 py-2 bg-white text-black rounded-lg font-semibold">Salvar Tudo</button>
                            </div>
                        </div>`;
                    
                    const tabButtons = modal.querySelectorAll('.tab-button');
                    const tabContents = modal.querySelectorAll('#settings-tab-content, #grades-tab-content');
                    
                    function switchTab(tabName) {
                        tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
                        tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `${tabName}-tab-content`));
                    }

                    tabButtons.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
                    switchTab(activeTab);

                    renderDefinitionsList(subject);
                    renderGradesList(subject);

                    feather.replace();
                    modal.querySelector('#save-all-button').addEventListener('click', () => handleSaveAllSubjectChanges(subject));
                    modal.querySelector('#add-definition-form').addEventListener('submit', (e) => handleAddAssessmentDefinition(e, subject));
                    
                    showModal('manageAssessments');
                }

                function renderDefinitionsList(subject) {
                    const list = document.getElementById('definitions-list');
                    if (!list) return;
                    list.innerHTML = '';
                    subject.assessmentDefinitions.forEach(def => {
                        list.innerHTML += `<li class="flex justify-between items-center p-3 bg-neutral-800 rounded-md"><span>${def.name} <span class="text-neutral-400">(Peso: ${def.maxScore})</span></span><button data-def-id="${def.id}" class="delete-definition-button text-red-500/70 hover:text-red-500"><i data-feather="trash-2" class="w-4 h-4"></i></button></li>`;
                    });
                    if (subject.assessmentDefinitions.length === 0) {
                        list.innerHTML = '<p class="text-neutral-500 text-center p-4">Nenhuma estrutura de avaliação definida.</p>';
                    }
                    document.querySelectorAll('.delete-definition-button').forEach(btn => btn.addEventListener('click', (e) => handleDeleteAssessmentDefinition(e, subject)));
                    feather.replace();
                }

                function renderGradesList(subject) {
                    const list = document.getElementById('grades-list');
                    if (!list) return;
                    list.innerHTML = '';
                    if (subject.assessmentDefinitions.length === 0) {
                        list.innerHTML = '<p class="text-neutral-500 text-center p-4">Defina a estrutura de avaliação na aba "Configurações" para poder lançar notas.</p>';
                        return;
                    }
                    subject.assessmentDefinitions.forEach(def => {
                        const assessment = subject.assessments.find(asm => asm.definitionId === def.id);
                        const score = assessment ? assessment.score : '';
                        list.innerHTML += `
                            <li class="flex justify-between items-center p-3 bg-neutral-800 rounded-md gap-4">
                                <label for="score-for-${def.id}" class="flex-1 text-neutral-200">${def.name}</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" step="0.01" id="score-for-${def.id}" data-def-id="${def.id}" value="${score}" placeholder="-" class="grade-score-input w-24 p-2 bg-neutral-700 border-neutral-600 rounded-md text-center">
                                    <span class="text-neutral-400">/ ${def.maxScore}</span>
                                </div>
                            </li>`;
                    });
                }

                function handleAddAssessmentDefinition(e, subject) {
                    e.preventDefault();
                    const name = document.getElementById('def-name').value.trim();
                    const maxScore = parseFloat(document.getElementById('def-max-score').value);
                    if (name && !isNaN(maxScore) && maxScore > 0) {
                        subject.assessmentDefinitions.push({ id: Date.now() + Math.random(), name, maxScore });
                        renderDefinitionsList(subject);
                        renderGradesList(subject);
                        document.getElementById('add-definition-form').reset();
                    } else {
                        alert("Por favor, preencha o nome e o peso (nota máx.) corretamente.");
                    }
                }

                function handleDeleteAssessmentDefinition(e, subject) {
                    const definitionId = parseFloat(e.currentTarget.dataset.defId);
                    subject.assessmentDefinitions = subject.assessmentDefinitions.filter(def => def.id !== definitionId);
                    subject.assessments = subject.assessments.filter(asm => asm.definitionId !== definitionId);
                    renderDefinitionsList(subject);
                    renderGradesList(subject);
                }

                function handleSaveAllSubjectChanges(subject) {
                    const newPassingGrade = parseFloat(document.getElementById('passing-grade-input').value);
                    if (!isNaN(newPassingGrade) && newPassingGrade >= 0 && newPassingGrade <= 100) {
                        subject.passingGrade = newPassingGrade;
                    }

                    const newAssessments = [];
                    const gradeRows = document.querySelectorAll('#grades-list li');
                    let allScoresValid = true;

                    gradeRows.forEach(row => {
                        const scoreInput = row.querySelector('.grade-score-input');
                        const definitionId = parseFloat(scoreInput.dataset.defId);
                        const definition = subject.assessmentDefinitions.find(d => d.id === definitionId);
                        
                        if (scoreInput.value.trim() !== '') {
                            const score = parseFloat(scoreInput.value);
                            
                            if (!definition || isNaN(score) || score < 0 || score > definition.maxScore) {
                                alert(`Nota inválida para "${definition.name}". Deve ser um número entre 0 e ${definition.maxScore}.`);
                                allScoresValid = false;
                                return;
                            }
                            
                            const existingAssessment = subject.assessments.find(asm => asm.definitionId === definitionId);
                            if (existingAssessment) {
                                existingAssessment.score = score;
                                newAssessments.push(existingAssessment);
                            } else {
                                newAssessments.push({ id: Date.now() + Math.random(), definitionId, score });
                            }
                        }
                    });

                    if (!allScoresValid) return;

                    subject.assessments = newAssessments;
                    
                    saveData();
                    hideModals();
                    showSubjectDetails(subject.id);
                }

                // =================================================================================
                // --- LÓGICA DO ASSISTENTE IA ---
                // =================================================================================
                function renderAiAssistant() {
                    const modal = modals.aiAssistant;
                    modal.innerHTML = `<div class="bg-neutral-900 p-8 rounded-2xl shadow-lg w-full max-w-3xl border border-neutral-700"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold text-white flex items-center gap-3"><i data-feather="cpu" class="text-blue-400"></i>Assistente IA</h3><button type="button" class="modal-cancel-button text-neutral-400 hover:text-white">&times;</button></div><div id="ai-initial-view"><div id="ai-suggestions-container" class="max-h-80 overflow-y-auto pr-2 mb-6"></div><h4 class="font-semibold mb-3 text-neutral-300">Perguntas Rápidas</h4><div id="ai-quick-questions" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div></div><div id="ai-answer-view" class="hidden"><button id="ai-back-button" class="text-blue-400 mb-4 flex items-center gap-2 text-sm"><i data-feather="arrow-left"></i> Voltar</button><div id="ai-answer-content"></div></div><div class="flex items-center justify-end mt-6 gap-4"><button type="button" class="modal-cancel-button px-6 py-2 bg-neutral-700 rounded-lg">Fechar</button></div></div>`;
                    
                    const suggestionsContainer = modal.querySelector('#ai-suggestions-container');
                    const questionsContainer = modal.querySelector('#ai-quick-questions');
                    const answerView = modal.querySelector('#ai-answer-view');
                    const initialView = modal.querySelector('#ai-initial-view');
                    const backButton = modal.querySelector('#ai-back-button');

                    const suggestions = generateAiSuggestions();
                    let suggestionsHTML = '';
                    if(suggestions.length === 0){ suggestionsHTML = `<div class="flex items-center gap-4 p-4"><i data-feather="coffee" class="w-6 h-6 text-green-400"></i><p>Tudo certo por aqui! Nenhum alerta crítico no momento. Continue o bom trabalho!</p></div>` }
                    else { suggestions.forEach(s => { suggestionsHTML += `<div class="flex items-start gap-4 p-4 bg-neutral-800/50 rounded-lg mb-3"><i data-feather="${s.icon}" class="w-6 h-6 ${s.color} mt-1"></i><p class="flex-1 text-neutral-300">${s.text}</p></div>`; }); }
                    suggestionsContainer.innerHTML = suggestionsHTML;

                    const questions = [ { key: 'worst_subject', text: 'Qual matéria precisa de mais atenção?' }, { key: 'best_subject', text: 'Qual minha melhor matéria?' }, { key: 'next_class', text: 'Qual minha próxima aula hoje?' }, { key: 'pending_tasks', text: 'O que preciso fazer?' } ];
                    questions.forEach(q => { questionsContainer.innerHTML += `<button data-question-key="${q.key}" class="ai-question-button text-left w-full p-3 bg-neutral-800 hover:bg-neutral-700 rounded-lg transition-colors">${q.text}</button>`; });

                    modal.querySelectorAll('.ai-question-button').forEach(btn => btn.addEventListener('click', () => handleAiQuickQuestion(btn.dataset.questionKey)));
                    backButton.addEventListener('click', () => { answerView.classList.add('hidden'); initialView.classList.remove('hidden'); });
                    
                    feather.replace();
                    showModal('aiAssistant');
                }

                function handleAiQuickQuestion(questionKey) {
                    const profile = getCurrentProfile();
                    const allSubjects = profile.semesters.flatMap(s => s.subjects).filter(s => s.assessments.length > 0);
                    let answer = { icon: 'help-circle', text: 'Não tenho dados suficientes para responder a isso ainda. Adicione mais matérias e avaliações no app!' };

                    if (questionKey === 'worst_subject') {
                        if (allSubjects.length > 0) { const worst = allSubjects.reduce((min, s) => calculateWeightedAverage(s.assessments, s.assessmentDefinitions) < calculateWeightedAverage(min.assessments, min.assessmentDefinitions) ? s : min); answer = { icon: 'trending-down', text: `A matéria que exige mais atenção é <strong>${worst.name}</strong>, com média <strong>${calculateWeightedAverage(worst.assessments, worst.assessmentDefinitions).toFixed(1)}%</strong>.` }; }
                    } else if (questionKey === 'best_subject') {
                        if (allSubjects.length > 0) { const best = allSubjects.reduce((max, s) => calculateWeightedAverage(s.assessments, s.assessmentDefinitions) > calculateWeightedAverage(max.assessments, max.assessmentDefinitions) ? s : max); answer = { icon: 'trending-up', text: `Sua melhor matéria é <strong>${best.name}</strong>, com uma ótima média de <strong>${calculateWeightedAverage(best.assessments, best.assessmentDefinitions).toFixed(1)}%</strong>. Parabéns!` }; }
                    } else if (questionKey === 'pending_tasks') {
                        const pending = profile.todos.filter(t => !t.completed);
                        if (pending.length > 0) { answer = { icon: 'list', text: `Você tem ${pending.length} tarefa(s) pendente(s): <ul class="mt-2">${pending.map(t => `<li class="ml-4 list-disc">${t.text}</li>`).join('')}</ul>` }; }
                        else { answer = { icon: 'check-circle', text: 'Você está em dia com suas tarefas! Nenhuma pendência encontrada.' }; }
                    } else if (questionKey === 'next_class') {
                        const dayMap = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                        const now = new Date();
                        const upcoming = Object.keys(profile.schedule).filter(k => k.startsWith(dayMap[now.getDay()]) && parseInt(k.split('-')[1]) >= now.getHours()).sort((a,b) => parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]));
                        if (upcoming.length > 0) {
                            const subject = profile.semesters.flatMap(s=>s.subjects).find(s => s.id === profile.schedule[upcoming[0]]);
                            if (subject) { answer = { icon: 'calendar', text: `Sua próxima aula hoje é <strong>${subject.name}</strong> às ${upcoming[0].split('-')[1]}:00.` }; }
                            else { answer = { icon: 'search', text: 'Encontrei um horário agendado, mas a matéria foi removida. Verifique sua grade.' }; }
                        } else { answer = { icon: 'coffee', text: 'Você não tem mais aulas agendadas para hoje. Aproveite para descansar ou estudar!' }; }
                    }

                    const answerContent = document.getElementById('ai-answer-content');
                    answerContent.innerHTML = `<div class="flex items-start gap-4 p-4 bg-neutral-800 rounded-lg"><i data-feather="${answer.icon}" class="w-6 h-6 text-blue-400 mt-1"></i><p class="flex-1 text-neutral-200">${answer.text}</p></div>`;
                    feather.replace();
                    document.getElementById('ai-initial-view').classList.add('hidden');
                    document.getElementById('ai-answer-view').classList.remove('hidden');
                }

                function generateAiSuggestions() {
                    const profile = getCurrentProfile();
                    const suggestions = [];
                    const allSubjects = profile.semesters.flatMap(s => s.subjects);
                    
                    if (allSubjects.length === 0) { suggestions.push({ icon: 'book-open', color: 'text-blue-400', text: 'Bem-vindo! Comece adicionando suas matérias na aba "Matérias" para que eu possa ajudar você a se organizar.' }); }

                    const subjectsWithAssessments = allSubjects.filter(s => s.assessments.length > 0);
                    const overallIra = parseFloat(calculateIra(subjectsWithAssessments));
                    if (overallIra < 7.0 && subjectsWithAssessments.length > 0) { suggestions.push({ icon: 'alert-triangle', color: 'text-yellow-400', text: `Seu IRA geral está em <strong>${overallIra.toFixed(2)}</strong>. Foque nas matérias com notas mais baixas.` }); }
                    subjectsWithAssessments.forEach(subject => { const avg = calculateWeightedAverage(subject.assessments, subject.assessmentDefinitions); if (avg < subject.passingGrade) { suggestions.push({ icon: 'alert-triangle', color: 'text-red-400', text: `Sua média em <strong>${subject.name}</strong> está baixa (${avg.toFixed(1)}%), abaixo da meta de ${subject.passingGrade}%. Dedique um tempo extra para esta matéria.` }); } });
                    
                    const pendingTodos = profile.todos.filter(t => !t.completed);
                    if (pendingTodos.length > 2) { suggestions.push({ icon: 'list', color: 'text-yellow-400', text: `Você tem <strong>${pendingTodos.length} tarefas pendentes</strong>. É uma boa hora para começar a resolvê-las!` }); }
                    
                    if (suggestions.length === 0 && (subjectsWithAssessments.length > 0 || profile.todos.length > 0)) { suggestions.push({ icon: 'check-circle', color: 'text-green-400', text: `Parabéns! Suas notas estão boas e você não tem muitas tarefas acumuladas. Continue assim!` }); }
                    return suggestions;
                }

                // =================================================================================
                // --- INICIALIZAÇÃO DA APLICAÇÃO ---
                // =================================================================================
                function init() {
                    // --- Preencher HTML dos Modais ---
                    document.getElementById('create-profile-screen').innerHTML = `<div class="bg-neutral-900 p-8 rounded-2xl shadow-lg w-full max-w-md"><h2 class="text-3xl font-bold mb-6 text-center">Criar Novo Perfil</h2><form id="create-profile-form" class="flex flex-col gap-4"><input type="text" id="profile-name" placeholder="Seu Nome" class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded-lg" required><input type="text" id="profile-university" placeholder="Sigla da Faculdade" class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded-lg" required><input type="url" id="profile-photo" placeholder="URL da foto (opcional)" class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded-lg"><div class="flex items-center justify-between mt-4 gap-4"><button type="button" id="cancel-creation-button" class="w-full px-6 py-3 bg-neutral-700 rounded-lg">Voltar</button><button type="submit" class="w-full px-6 py-3 bg-white text-black rounded-lg font-semibold">Criar</button></div></form></div>`;
                    modals.addSemester.innerHTML = `<div class="bg-neutral-900 p-8 rounded-2xl shadow-lg w-full max-w-md"><h3 class="text-2xl font-bold mb-6">Adicionar Novo Semestre</h3><form id="add-semester-form"><input type="text" id="semester-name" placeholder="Nome do Semestre (ex: 2025.1)" class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded-lg" required><div class="flex items-center justify-end mt-6 gap-4"><button type="button" class="modal-cancel-button px-6 py-2 bg-neutral-700 rounded-lg">Cancelar</button><button type="submit" class="px-6 py-2 bg-white text-black rounded-lg font-semibold">Salvar</button></div></form></div>`;
                    modals.addSubject.innerHTML = `<div class="bg-neutral-900 p-8 rounded-2xl shadow-lg w-full max-w-md"><h3 class="text-2xl font-bold mb-6">Adicionar Nova Matéria</h3><form id="add-subject-form"><div class="flex flex-col gap-4"><input type="text" id="subject-name" placeholder="Nome da Matéria (ex: Cálculo I)" class="w-full p-3 bg-neutral-800 border-neutral-700 rounded-lg" required><input type="text" id="subject-acronym" placeholder="Sigla (ex: CALC1)" class="w-full p-3 bg-neutral-800 border-neutral-700 rounded-lg"><input type="text" id="subject-professor" placeholder="Nome do Professor" class="w-full p-3 bg-neutral-800 border-neutral-700 rounded-lg"><input type="text" id="subject-classroom" placeholder="Sala (ex: B-204)" class="w-full p-3 bg-neutral-800 border-neutral-700 rounded-lg"><input type="number" id="subject-credits" placeholder="Carga Horária (Créditos)" class="w-full p-3 bg-neutral-800 border-neutral-700 rounded-lg"><div class="mb-2"><label class="block text-sm font-medium text-neutral-400 mb-2">Cor do Marcador</label><div id="color-options" class="flex gap-3"></div></div></div><div class="flex items-center justify-end mt-6 gap-4"><button type="button" class="modal-cancel-button px-6 py-2 bg-neutral-700 rounded-lg">Cancelar</button><button type="submit" class="px-6 py-2 bg-white text-black rounded-lg font-semibold">Salvar</button></div></form></div>`;
                    modals.addToSchedule.innerHTML = `<div class="bg-neutral-900 p-8 rounded-2xl shadow-lg w-full max-w-md"><h3 class="text-2xl font-bold mb-6">Adicionar aula em <span id="schedule-modal-timeslot"></span></h3><div id="schedule-subject-list" class="flex flex-col gap-2 max-h-60 overflow-y-auto"></div><div class="flex items-center justify-end mt-6"><button type="button" class="modal-cancel-button px-6 py-2 bg-neutral-700 rounded-lg">Cancelar</button></div></div>`;
                    modals.deleteConfirmation.innerHTML = `<div class="bg-neutral-900 p-8 rounded-2xl shadow-lg w-full max-w-md"><h3 class="text-2xl font-bold mb-4">Confirmar Exclusão</h3><p id="delete-confirmation-message" class="text-neutral-300 mb-6">Você tem certeza?</p><div class="flex items-center justify-end mt-6 gap-4"><button id="cancel-delete-button" class="px-6 py-2 bg-neutral-700 rounded-lg">Cancelar</button><button id="confirm-delete-button" class="px-6 py-2 bg-red-600 rounded-lg font-semibold">Excluir</button></div></div>`;
                    
                    // --- Carregar Dados e Iniciar ---
                    loadData();
                    renderProfiles();
                    showScreen('profileSelection');
                    Chart.defaults.color = '#9ca3af';

                    const colorContainer = document.getElementById('color-options');
                    if(colorContainer) {
                        Object.keys(subjectColors).forEach(color => { colorContainer.innerHTML += `<label class="cursor-pointer"><input type="radio" name="color-choice" value="${color}" class="sr-only peer"><div class="w-8 h-8 rounded-full ${subjectColors[color].border.replace('border-', 'bg-')} peer-checked:ring-2 ring-white ring-offset-2 ring-offset-black"></div></label>`; });
                    }
                    
                    // --- Event Listeners Globais ---
                    document.getElementById('add-profile-button').addEventListener('click', () => showScreen('createProfile'));
                    document.getElementById('cancel-creation-button').addEventListener('click', () => showScreen('profileSelection'));
                    document.getElementById('logout-button').addEventListener('click', logout);
                    document.getElementById('ai-assistant-button').addEventListener('click', renderAiAssistant);
                    document.querySelectorAll('.nav-button').forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
                    document.body.addEventListener('click', (e) => {
                        if (e.target.classList.contains('modal-cancel-button')) {
                            hideModals();
                        }
                    });
                    document.getElementById('cancel-delete-button').addEventListener('click', hideModals);
                    document.getElementById('confirm-delete-button').addEventListener('click', handleDeleteItem);
                    document.getElementById('create-profile-form').addEventListener('submit', handleCreateProfile);
                    document.getElementById('add-semester-form').addEventListener('submit', handleAddSemester);
                    document.getElementById('add-subject-form').addEventListener('submit', handleAddSubject);
                    
                    feather.replace();
                }

                init();
            });
        } catch (error) {
            console.error("A critical error occurred in the application:", error);
            document.body.innerHTML = '<div class="min-h-screen flex items-center justify-center bg-black text-white p-4"><div class="text-center"><h1 class="text-2xl font-bold text-red-500">Ocorreu um Erro Crítico</h1><p class="mt-2 text-neutral-400">Por favor, recarregue a página. Se o problema persistir, limpe os dados do site.</p></div></div>';
        }
    </script>
</body>
</html>
